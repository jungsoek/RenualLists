# 251211목__개선 사항

## Controller10 → Controller11

### 1. 프로젝트 버전 로깅

#### 개선 사항

프로젝트 버전 로깅 기능을 추가하였습니다.

프로젝트의 Setup 부분에 추가하였습니다.

***main.c***

```c
//Setup
	FUNCTION = SPACE;
	HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_SET); //Turn on led
	HAL_GPIO_WritePin(DEVICE_GPIO_Port, DEVICE_Pin, GPIO_PIN_SET);
	LOG("[DEBUG]", "STM32 OK!\n");
	LOG("[VER]", "Controller_v0.10.1\n");
...
    
```

#### 테스트

```terminal
10:23:40.514 [DEBUG]STM32 OK!
10:23:40.514 #[VER]Controller_v0.10.1
```

### 2. I2C HAL_BUSY로 인한 App 장애

#### 개선 사항

```c
LOG("[ANS]", "FAIL");
```

해당 로그로 인해 App에서 단계 진행이 안되었습니다.

때문에,

***Src/Handlers/Handshake.c***

```c
LOG("[ANS]", "SYSTEM_FAIL");
```

로 로그를 수정하였고,

FAIL이 되어도 App의 단계 진행은 계속되도록 조치하였습니다.

또한, 아래 코드와 같이 어느 부분에서 에러가 났는지 알리는 LOG Flag를 추가하였습니다.

***Src/Handlers/Handshake.c***

```c
// -------- 결과 처리 --------
    if (error_code == 0)
    {
        LOG("[ANS]", "ALL_OK");
    }
    else
    {
        LOG("[ANS]", "SYSTEM_FAIL");

        // I2C 상태 자동 점검
        I2C_DumpDevices(&hi2c1);

        if (error_code & ERR_SIM)      LOG("[ERR]", "SIM_FAIL");
        if (error_code & ERR_LASER)    LOG("[ERR]", "LASER_FAIL");
        if (error_code & ERR_ULTRA)    LOG("[ERR]", "ULTRA_FAIL");
        if (error_code & ERR_LOADCELL) LOG("[ERR]", "LOADCELL_FAIL");
        if (error_code & ERR_WATER)    LOG("[ERR]", "WATER_SENSOR_FAIL");
    }
```

또한 말씀하신 바와 같이 지금은 사용하지 않는 레이저 센서(VL53L0X)를 주석처리 하였습니다.

***Src/Handlers/Handshake.c***

```c
// -------- 센서 체크 --------
    CheckSIM();
//    CheckLaser();
    CheckUltra();
    CheckLoadcell();
    CheckWater();
```

현재는 주석처리로만 마무리 하였지만 추후에는 하드웨어 계층을 나누어서 해당 계층에서 센서를 비활성화 시키겠습니다. 

#### 테스트 



### 3. 코드 간소화

#### 개선 사항

아래와 같이 case마다 모듈화 및 함수 단일화를 진행했습니다.

***main.c***

```c
...
    
switch (FUNCTION) {
			case HANDSHAKE:
				Handshake();
				break;

			case VALIDATION:
				Validation();
				break;

			case POST_UCO:
				PostUCO();
			    break;

			case POST_PER:
				PostPeriodic();
				break;

			case OPEN_INPUT:
				DoorOpen_Measure();
				break;

			case CLOSE_INPUT:
				DoorClose_Measure();
				break;

			case RECHECK:
				Recheck();
				break;

			case UNLOCK_DOOR:
				UnlockDoor();
				break;

			case SLEEP:
				SleepMode();
				break;

			case ALARM_WAKEUP:
				AlarmWakeUpMode();
				break;
        
...
```

#### 테스트



### 4. 파일 트리 개선

#### 개선 사항

아래와 같이 switch-case 문의 상태에 따른 동작들을 handlers 디렉터리에 정리하였습니다.

추후에는 프로젝트의

* 하드웨어 드라이버 모듈
* 하드웨어 점검 및 초기화 모듈
  * 하드웨어 리셋
  * 펌웨어 레지스터
* 에러 및 예외 처리 모듈
* 로그 출력 모듈
* 더미 데이터 출력 모듈
* 기능 테스트 모듈
* 통합 테스트 모듈

등으로 디렉터리를 구조화 및 정돈할 예정입니다.

![image-20251211190818008](C:\Users\bb\Desktop\refeed\RenualList\assets\image-20251211190818008.png)

#### 테스트



### Git/GitHub를 통한 App 빌드 업무 개선

#### 개선 사항

Flutter App 설치를 위한 GitHub 리포지토리를 생성하였고 App 설치 과정을 조금 더 편리하게 하였습니다.

추수에는 CI/CD를 통해 Git Push 만으로 App 빌드가 되도록 개선하겠습니다.

#### 테스트